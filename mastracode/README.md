# Mastra Code

A terminal-based coding agent TUI built with [Mastra](https://mastra.ai) and [pi-tui](https://github.com/badlogic/pi-mono).

## Features

- ğŸ¤– **Multi-model support**: Use Claude, GPT, Gemini, and 70+ other models via Mastra's unified model router
- ğŸ” **OAuth login**: Authenticate with Anthropic (Claude Max) and OpenAI (ChatGPT Plus/Codex)
- ğŸ’¾ **Persistent conversations**: Threads are saved per-project and resume automatically
- ğŸ› ï¸ **Coding tools**: View files, edit code, run shell commands
- ğŸ“‹ **Plan persistence**: Approved plans are saved as markdown files for future reference
- ğŸ“Š **Token tracking**: Monitor usage with persistent token counts per thread
- ğŸ¨ **Beautiful TUI**: Polished terminal interface with streaming responses

## Installation

Install `mastracode` globally with your package manager of choice.

```bash
npm install -g mastracode
```

If you prefer not to install packages globally, you can use `npx`:

```bash
npx mastracode
```

On first launch, an interactive onboarding wizard guides you through:

1. **Authentication** â€” log in with your AI provider (Anthropic, OpenAI, etc.)
2. **Model packs** â€” choose default models for each mode (build / plan / fast)
3. **Observational Memory** â€” pick a model for OM (learns about you over time)
4. **YOLO mode** â€” auto-approve tool calls, or require manual confirmation

You can re-run setup anytime with `/setup`.

## Prerequisites

### Optional: `fd` for file autocomplete

The `@` file autocomplete feature uses [`fd`](https://github.com/sharkdp/fd), a fast file finder that respects `.gitignore`. Without it, `@` autocomplete silently does nothing.

Install with your package manager:

```bash
# macOS
brew install fd

# Ubuntu/Debian
sudo apt install fd-find

# Arch
sudo pacman -S fd
```

On Ubuntu/Debian the binary is called `fdfind` â€” mastracode detects both `fd` and `fdfind` automatically.

## Usage

### Starting a conversation

Type your message and press Enter. The agent responds with streaming text.

### `@` file references

Type `@` followed by a partial filename to fuzzy-search project files and reference them in your message. This requires `fd` to be installed (see [Prerequisites](#prerequisites)).

- `@setup` â€” fuzzy-matches files like `setup.ts`, `setup.py`, etc.
- `@src/tui` â€” scoped search within a directory
- `@"path with spaces"` â€” quoted form for paths containing spaces

Select a suggestion with arrow keys and press Tab to insert it.

### Slash commands

| Command           | Description                                  |
| ----------------- | -------------------------------------------- |
| `/new`            | Start a new conversation thread              |
| `/threads`        | List and switch between threads              |
| `/models`         | Switch/manage model packs (built-in/custom)  |
| `/mode`           | Switch agent mode                            |
| `/subagents`      | Configure subagent model defaults            |
| `/om`             | Configure Observational Memory models        |
| `/think`          | Set thinking level (Anthropic)               |
| `/skills`         | List available skills                        |
| `/diff`           | Show modified files or git diff              |
| `/name`           | Rename current thread                        |
| `/cost`           | Show token usage and estimated costs         |
| `/review`         | Review a GitHub pull request                 |
| `/hooks`          | Show/reload configured hooks                 |
| `/mcp`            | Show/reload MCP server connections           |
| `/sandbox`        | Manage allowed paths (add/remove dirs)       |
| `/permissions`    | View/manage tool approval permissions        |
| `/settings`       | General settings (notifications, YOLO, etc.) |
| `/yolo`           | Toggle YOLO mode (auto-approve all tools)    |
| `/resource`       | Show/switch resource ID (tag for sharing)    |
| `/thread:tag-dir` | Tag current thread with this directory       |
| `/login`          | Authenticate with OAuth providers            |
| `/logout`         | Log out from a provider                      |
| `/setup`          | Re-run the interactive setup wizard          |
| `/help`           | Show available commands                      |
| `/exit`           | Exit the TUI                                 |

### Keyboard shortcuts

| Shortcut | Action                            |
| -------- | --------------------------------- |
| `Ctrl+C` | Interrupt current operation       |
| `Ctrl+D` | Exit (when editor is empty)       |
| `Ctrl+T` | Toggle thinking blocks visibility |
| `Ctrl+E` | Expand/collapse all tool outputs  |

## Configuration

### Project-based threads

Threads are automatically scoped to your project based on:

1. Git remote URL (if available)
2. Absolute path (fallback)

This means conversations are shared across clones, worktrees, and SSH/HTTPS URLs of the same repository.

### Database location

The SQLite database is stored in your system's application data directory:

- **macOS**: `~/Library/Application Support/mastracode/`
- **Linux**: `~/.local/share/mastracode/`
- **Windows**: `%APPDATA%/mastracode/`

### Authentication

For **Anthropic** models, mastracode supports two authentication methods:

1. **Claude Max OAuth (primary)** â€” Use `/login` to authenticate with a Claude Pro/Max subscription. This is the recommended approach.
2. **API key (fallback)** â€” Set the `ANTHROPIC_API_KEY` environment variable for direct API access. This is used when not logged in via OAuth.

When both are available, Claude Max OAuth takes priority.

For **other providers** (OpenAI, Google, etc.), set the corresponding environment variable (e.g., `OPENAI_API_KEY`, `GOOGLE_GENERATIVE_AI_API_KEY`) or use OAuth where supported.

Credentials are stored alongside the database in `auth.json`.

### Plan persistence

When you approve a plan (via `submit_plan`), it is saved as a markdown file in the app data directory:

- **macOS**: `~/Library/Application Support/mastracode/plans/<resourceId>/`
- **Linux**: `~/.local/share/mastracode/plans/<resourceId>/`
- **Windows**: `%APPDATA%/mastracode/plans/<resourceId>/`

Files are named `<timestamp>-<slugified-title>.md` and contain the plan title, approval timestamp, and full plan body.

To save plans to a project-local directory instead, set the `MASTRA_PLANS_DIR` environment variable:

```bash
export MASTRA_PLANS_DIR=.mastracode/plans
```

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TUI                                â”‚
â”‚  (pi-tui components: Editor, Markdown, Loader, etc.)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Harness                              â”‚
â”‚  - Mode management (plan, build, review)                    â”‚
â”‚  - Thread/message persistence                               â”‚
â”‚  - Event system for TUI updates                             â”‚
â”‚  - State management with Zod schemas                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Mastra Agent                           â”‚
â”‚  - Dynamic model selection                                  â”‚
â”‚  - Tool execution (view, edit, bash)                        â”‚
â”‚  - Memory integration                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LibSQL Storage                         â”‚
â”‚  - Thread persistence                                       â”‚
â”‚  - Message history                                          â”‚
â”‚  - Token usage tracking                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Development

```bash
# Run in development mode (with watch)
pnpm dev

# Type check
pnpm typecheck

# Build
pnpm build
```

## Credits

- [Mastra](https://mastra.ai) - AI agent framework
- [pi-mono](https://github.com/badlogic/pi-mono) - TUI primitives and inspiration
- [OpenCode](https://github.com/sst/opencode) - OAuth provider patterns

## License

Apache-2.0
